var nav_data = {
    active   : nav_active,
    base_url : base_url
}

$.getJSON(base_url + '/api/menu/nav', function(res) {
    nav_data.data = res.data;
    $('#navContent').html(template('navTemplate', nav_data));
	$("#navigation .dropdown").on("show.bs.dropdown",
	function() {
		$(this).find(".dropdown-menu").addClass("animated fadeInLeft")
	}),
    $("#navigation .dropdown.open").data("closable", !1),
	$("#navigation .menu >.dropdown").on({
		"shown.bs.dropdown": function() {
			$(this).data("closable", !1),
			$("#sidebar").getNiceScroll().resize()
		},
		click: function(o) {
			$(this).data("closable", !0),
			$(this).hasClass("open") || $("li.dropdown.open").removeClass("open"),
			$("#sidebar").hasClass("collapsed") && o.stopPropagation(),
			$("#sidebar").getNiceScroll().resize()
		},
		"hide.bs.dropdown": function() {
			return $(this).data("closable")
		}
	}),
	$(".sidebar-collapse a").on("click",
	function() {
		$("#sidebar, #navbar").toggleClass("collapsed"),
		$("#navigation").find(".dropdown.open").removeClass("open"),
		$("#navigation").find(".dropdown-menu.animated").removeClass("animated"),
		$("#sidebar > li.collapsed").removeClass("collapsed"),
		$("#sidebar").hasClass("collapsed") ? $(window).width() < 1024 ? $("#content").animate({
			left: "0px"
		},
		150) : $("#content").animate({
			paddingLeft: "55px",
			paddingRight: "0px"
		},
		150) : $(window).width() < 1024 ? $("#content").animate({
			left: "210px"
		},
		150) : $("#content").animate({
			paddingLeft: "265px",
			paddingRight: "0px"
		},
		150)
	}),
	$("#navigation .menu li").hover(function() {
		$(this).addClass("hovered"),
		$("#sidebar").addClass("open");

        var img = $(this).find("img");
        if (img.length > 0 && img.attr('src').match(/.*-1.png/) == null)
            img.attr('src', img.attr('src').replace(/(.*)\.png/,"$1-1.png"));
	},
	function(o) {
		$(o.target).parent().removeClass("hovered"),
		$(this).removeClass("hovered"),
		$("#sidebar").removeClass("open");

        var img = $(this).find("img");
        if (img.length > 0 && $(this).hasClass('active') == false)
            img.attr('src', img.attr('src').replace(/(.*)\-1.png/,"$1.png"));
	});

	$("#navigation .no-toggle").on({
        click:function(){
            window.location.href = $(this).attr('href');
            return false;
        }
    });

});

$('.usernameLocation').html(login_user.nickName);
$(".user .popoverAction").data('uid', login_user.id);

function popup_alert(options) {
    var defaults = {
        dismissQueue: true,
        layout      : 'topCenter',
        theme       : 'bootstrapTheme',
        maxVisible  : 10,
        timeout     : 2000
    }

    var options = $.extend(defaults, options);

    noty(options);
}

function popup_confirm(options) {
    var defaults = {
        dismissQueue: true,
        layout: 'center',
        theme: 'defaultTheme',
        ok: function(){},
        cancel: function(){}
    }

    var options = $.extend(defaults, options);

    options.buttons = [
        {addClass: 'btn btn-primary', text: '确定', onClick: function ($noty) {
            $noty.close();
            //noty({dismissQueue: true, force: true, layout: layout, theme: 'defaultTheme', text: 'You clicked "Ok" button', type: 'success'});
            options.ok();
        }
        },
        {addClass: 'btn btn-danger', text: '取消', onClick: function ($noty) {
            $noty.close();
            //noty({dismissQueue: true, force: true, layout: layout, theme: 'defaultTheme', text: 'You clicked "Cancel" button', type: 'error'});
            options.cancel();
        }
        }
    ]

    noty(options);
}

function remove_empty(object) {

    $.each(object, function(k, v) {
        if(object[k].length < 1) {
            delete object[k];
        }
    });

    return object;
}

template.helper('log', function (content) {
    console.log(content);
});

template.helper('convert', function (str, type) {
    var result = null;

    switch (type.toLowerCase()) {
        case 'int':
            result = parseInt(str);
            break;
        case 'float':
            result = parseFloat(str);
            break;
    }

    return result;
});

template.helper('sub', function (str, length) {
    var result = null;

    if (typeof(str) == 'string') {
        var char = str.replace(/[^\x00-\xff]/g, '**');

        if (char.length < length) {
            result = str;
        } else {
            result = str.slice(0, length * 2) + '......';
        }
    }

    return result;
});

template.helper('slice', function (str, start, end) {
    if (typeof(str) == 'string') {
        return str.substr(start, end);
    }
});

template.helper('lastIndexOf', function (str, search) {
    return str.lastIndexOf(search);
});

function removeModal(modalId) {
    var modal = document.querySelector('#' + modalId);
    classie.remove( modal, 'md-show' );
}

function showModal(modalId) {
    var modal   = document.querySelector('#' + modalId),
        overlay = document.querySelector('.md-overlay');

    classie.add( modal, 'md-show' );
    overlay.removeEventListener('click', removeModal);
    overlay.addEventListener('click', removeModal);
}

var widthLess1024 = function() {
	$(window).width() < 1024 ? ($("#sidebar, #navbar").addClass("collapsed"), $("#navigation").find(".dropdown.open").removeClass("open"), $("#navigation").find(".dropdown-menu.animated").removeClass("animated"), $("#sidebar").hasClass("collapsed") ? $("#content").animate({
		left: "0px",
		paddingLeft: "55px"
	},
	150) : $("#content").animate({
		paddingLeft: "55px"
	},
	150)) : ($("#sidebar, #navbar").removeClass("collapsed"), $("#sidebar").hasClass("collapsed") ? $("#content").animate({
		left: "210px",
		paddingLeft: "181px",
        paddingRight: "0px",
		paddingBottom: "30px"
	},
	150) : $("#content").animate({
		paddingLeft: "181px",
        paddingRight: "0px",
		paddingBottom: "30px"
	},
	150))
},
widthLess768 = function() {
	$(window).width() < 768 ? (1 === $(".collapsed-content .search").length && $("#main-search").appendTo(".collapsed-content .search"), 0 === $(".collapsed-content li.user").length && $(".collapsed-content li.search").after($("#current-user"))) : ($("#current-user").show(), 2 === $(".collapsed-content .search").length && $(".nav.refresh").after($("#main-search")), 1 === $(".collapsed-content li.user").length && $(".quick-actions >li:last-child").before($("#current-user")))
};
$(function() {

	function o(o) {
		$(o).block({
			message: '<div class="el-reloader"></div>',
			overlayCSS: {
				opacity: .6,
				cursor: "wait",
				backgroundColor: "#000000"
			},
			css: {
				padding: "5px",
				border: "0",
				backgroundColor: "transparent"
			}
		})
	}
	function e(o) {
		$(o).unblock()
	}
	$("#mmenu").mmenu({
		position: "right",
		zposition: "next",
		moveBackground: !1
	}),
	$(".quick-actions .dropdown").on("show.bs.dropdown",
	function() {
		$(this).find(".dropdown-menu").addClass("animated fadeInDown"),
		$(this).find("#user-inbox").addClass("animated bounceIn")
	}),
	$("#sales-chart").sparkline([5, 6, 7, 2, 1, 4, 6, 8, 10, 14], {
		width: "60px",
		type: "bar",
		height: "40px",
		barWidth: "6px",
		barSpacing: 1,
		barColor: "#d9544f"
	}),
	$("#balance-chart").sparkline([5, 6, 7, 2, 1, 4, 6, 8, 10, 14], {
		width: "60px",
		type: "bar",
		height: "40px",
		barWidth: "6px",
		barSpacing: 1,
		barColor: "#418bca"
	}),
	$("#sidebar .sidebar-toggle").on("click",
	function() {
		var o = $(this).data("toggle");
		$(o).toggleClass("collapsed")
	}),
	$("#sidebar").niceScroll({
		cursorcolor: "#000000",
		zindex: 999999,
		bouncescroll: !0,
		cursoropacitymax: .4,
		cursorborder: "",
		cursorborderradius: 0,
		cursorwidth: "7px",
		railalign: "left",
		railoffset: {
			top: 45,
			left: 0
		}
	});
	var n = function() {
		$("#content").niceScroll({
			cursorcolor: "#000000",
			zindex: 999999,
			bouncescroll: !0,
			cursoropacitymax: .4,
			cursorborder: "",
			cursorborderradius: 7,
			cursorwidth: "7px",
			background: "rgba(0,0,0,.1)",
			autohidemode: !1,
			railpadding: {
				top: 0,
				right: 2,
				left: 2,
				bottom: 0
			}
		})
	};
	n(),
	$("#mmenu").on("opened.mm",
	function() {
		$("#content").getNiceScroll().hide()
	}),
	$("#mmenu").on("closed.mm",
	function() {
		$("#content").getNiceScroll().show()
	}),
	$(".modal").on("show.bs.modal",
	function() {
		$("body, #content").css({
			overflow: "hidden"
		}),
		$("#content").getNiceScroll().remove()
	}).on("hide.bs.modal",
	function() {
		$("body, #content").css({
			overflow: ""
		}),
		n()
	}),
    widthLess1024(),
	widthLess768(),
	$(window).resize(function() {
		widthLess1024(),
		widthLess768()
	}),
	$(".animate-number").each(function() {
		var o = $(this).data("value"),
		e = $(this).data("animation-duration");
		$(this).animateNumbers(o, !0, e, "linear")
	}),
	$(".animate-progress-bar").each(function() {
		var o = $(this).data("percentage");
		$(this).css("width", o)
	}),
	$("#color-schemes li a").click(function() {
		var o = $(this).attr("class"),
		e = $("body").attr("class").split(" ").pop();
		$("body").removeClass(e).addClass(o)
	});
	var a = function() {
		$("body .videocontent").prepend('<div class="video-background video-bg-1"></div>'),
		$(".video-background").videobackground({
			videoSource: [["assets/videobg/1.mp4", "video/mp4"], ["assets/videobg/1.webm", "video/webm"], ["assets/videobg/1.ogv", "video/ogg"]],
			controlPosition: "#video",
			loop: !0,
			controlText: "",
			loadedCallback: function() {
				$(this).videobackground("mute")
			}
		})
	},
	i = function() {
		var o = $(".video-background").attr("class").split(" ").pop().split("-").pop();
		$(".video-background").videobackground({
			videoSource: [["assets/videobg/" + o + ".mp4", "video/mp4"], ["assets/videobg/" + o + ".webm", "video/webm"], ["assets/videobg/" + o + ".ogv", "video/ogg"]],
			controlPosition: "#video",
			loop: !0,
			controlText: "",
			loadedCallback: function() {
				$(this).videobackground("mute")
			}
		})
	};
	$("#videobackgrounds li a").click(function() {
		var o = $(this).attr("class");
		$("#video").html(""),
		$("body .videocontent").prepend('<div class="video-background"></div>'),
		$(".video-background").addClass(o),
		i(),
		$("#videobg-check").prop("checked", !0)
	}),
	$("#videobg-check").is(":checked") && a(),
	$("#videobg-check").change(function() {
		$(this).is(":checked") ? a() : ($("#video").html(""), $(this).prop("checked", !1))
	}),
	$(".page-refresh").click(function() {
		location.reload()
	}),
	$(".tile-header .controls .refresh").click(function() {
		var n = $(this).parent().parent().parent();
		return o(n),
		window.setTimeout(function() {
			e(n)
		},
		1e3),
		!1
	}),
	$(".tile-header .controls .remove").click(function() {
		return $(this).parent().parent().parent().addClass("animated fadeOut"),
		$(this).parent().parent().parent().attr("id", "el_remove"),
		setTimeout(function() {
			$("#el_remove").remove()
		},
		500),
		!1
	}),
	$(".tile-header .controls .minimize").click(function() {
		return $(this).parent().parent().parent().toggleClass("minimized"),
		!1
	}),
	navigator.userAgent.match(/iPhone|iPad|iPod/i) && ($(".modal").on("show.bs.modal",
	function() {
		setTimeout(function() {
			scrollLocation = $(window).scrollTop(),
			$(".modal").addClass("modal-ios").height($(window).height()).css({
				"margin-top": scrollLocation + "px"
			})
		},
		0)
	}), $("input, textarea").on("blur",
	function() {
		setTimeout(function() {
			$(window).scrollLeft(0);
			var o = $(":focus");
			o.is("input") || $(window).scrollTop(scrollLocation)
		},
		0)
	}))

    // custom

}),
$(window).load(function() {
	$("#loader").delay(500).fadeOut(300),
	$(".mask").delay(800).fadeOut(300,
	function() {
		widthLess1024(),
		widthLess768()
	})
});

var originalLeave = $.fn.popover.Constructor.prototype.leave;
$.fn.popover.Constructor.prototype.leave = function(obj){
  var self = obj instanceof this.constructor ?
    obj : $(obj.currentTarget)[this.type](this.getDelegateOptions()).data('bs.' + this.type)
  var container, timeout;

  originalLeave.call(this, obj);

  if(obj.currentTarget) {
    container = $(obj.currentTarget).siblings('.user-popover')
    timeout = self.timeout;
    container.one('mouseenter', function(){
      //We entered the actual popover – call off the dogs
      clearTimeout(timeout);
      //Let's monitor popover content instead
      container.one('mouseleave', function(){
        $.fn.popover.Constructor.prototype.leave.call(self, self);
      });
    })
  }
};



function getCookie(c_name)
{
    if (document.cookie.length>0)
    {
        c_start=document.cookie.indexOf(c_name + "=")
        if (c_start!=-1)
        {
            c_start=c_start + c_name.length+1
            c_end=document.cookie.indexOf(";",c_start)
            if (c_end==-1) c_end=document.cookie.length
            return unescape(document.cookie.substring(c_start,c_end))
        }
    }
    return ""
}

var UserInfo = function () {
    $.get(base_url + "/api/user/show", {id:login_user.id}, function(res) {
        var user = res.data;
        $("#current-user img").attr({"src":"/"+user.user.photo});
        UserCards = res.data.profile;
        UserCards.photo = user.user.photo;
        login_user.region = res.data.profile.region;
        updateAnchorPop();
    });
    // if (getCookie('avastar') != "")
    //     $("#current-user img").attr('src', getCookie('avastar'));
}();